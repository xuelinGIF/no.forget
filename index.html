<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>同步备忘录</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#10B981',
                        warning: '#F59E0B',
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .sync-pulse {
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0% { opacity: 1; }
                50% { opacity: 0.5; }
                100% { opacity: 1; }
            }
            .copy-toast {
                animation: fadein 0.5s, fadeout 0.5s 2.5s;
            }
            @keyframes fadein {
                from { bottom: 0; opacity: 0; }
                to { bottom: 30px; opacity: 1; }
            }
            @keyframes fadeout {
                from { bottom: 30px; opacity: 1; }
                to { bottom: 0; opacity: 0; }
            }
            .modal-enter {
                animation: modalIn 0.3s ease forwards;
            }
            .modal-exit {
                animation: modalOut 0.3s ease forwards;
            }
            @keyframes modalIn {
                from { opacity: 0; transform: scale(0.95); }
                to { opacity: 1; transform: scale(1); }
            }
            @keyframes modalOut {
                from { opacity: 1; transform: scale(1); }
                to { opacity: 0; transform: scale(0.95); }
            }
            .delete-error {
                animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
            }
            @keyframes shake {
                10%, 90% { transform: translateX(-1px); }
                20%, 80% { transform: translateX(2px); }
                30%, 50%, 70% { transform: translateX(-3px); }
                40%, 60% { transform: translateX(3px); }
            }
            .fullscreen-modal {
                max-width: 80vw;
                max-height: 80vh;
                width: 100%;
                height: 100%;
            }
            .file-preview {
                transition: transform 0.2s;
            }
            .file-preview:hover {
                transform: scale(1.02);
            }
            .upload-progress {
                height: 4px;
                background: linear-gradient(90deg, #4F46E5 0%, #818CF8 100%);
                width: 0%;
                transition: width 0.3s ease;
            }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 min-h-screen">
    <!-- 复制成功提示 -->
    <div id="copyToast" class="fixed bottom-0 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg opacity-0 pointer-events-none copy-toast hidden">
        已复制到剪贴板
    </div>

    <header class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-sticky-note text-primary text-2xl"></i>
                <h1 class="text-xl font-bold">同步备忘录<br>power of 无处不宅</h1>
            </div>
            
            <div class="flex items-center space-x-4">
                <button id="syncBtn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 relative">
                    <i class="fa fa-refresh" id="syncIcon"></i>
                    <span id="syncBadge" class="absolute top-0 right-0 w-2 h-2 bg-green-500 rounded-full hidden"></span>
                </button>
                <button id="forceSyncBtn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" title="强制同步">
                    <i class="fa fa-exclamation-circle text-warning text-sm"></i>
                </button>
                <button id="themeToggle" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i class="fa fa-moon-o dark:hidden"></i>
                    <i class="fa fa-sun-o hidden dark:inline"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6">
        <!-- GitHub设置区域（带复制功能） -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-4 mb-6">
            <h3 class="font-bold mb-3 flex items-center">
                <i class="fa fa-github mr-2"></i> GitHub同步设置
            </h3>
            <div class="flex flex-col md:flex-row gap-4 mb-3">
                <input type="text" id="githubToken" placeholder="GitHub个人访问令牌（需gist权限）" 
                    class="flex-1 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700">
                
                <button id="saveGithubSettings" class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-lg">
                    保存设置
                </button>
            </div>
            
            <!-- 显示当前连接的Gist ID，带复制按钮 -->
            <div class="text-sm text-gray-600 dark:text-gray-300 mb-2">
                <div class="flex items-center">
                    <span class="font-medium mr-2">当前Gist ID：</span>
                    <span id="currentGistId" class="font-mono bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded mr-2">未连接</span>
                    <button id="copyGistIdBtn" class="text-primary hover:text-primary/80 text-xs p-1" title="复制Gist ID">
                        <i class="fa fa-copy mr-1"></i>复制
                    </button>
                </div>
                <p class="mt-1 text-xs text-gray-500">（两台终端需显示相同的Gist ID才会同步）</p>
            </div>
            
            <!-- 手动输入Gist ID的选项 -->
            <div class="flex flex-col md:flex-row gap-2 mt-3">
                <input type="text" id="manualGistId" placeholder="手动输入Gist ID（粘贴从其他设备复制的ID）" 
                    class="flex-1 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-sm">
                
                <button id="setManualGistId" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-4 py-2 rounded-lg text-sm">
                    手动设置Gist ID
                </button>
            </div>
        </div>
        
        <!-- 添加备忘录区域 -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-4 mb-6">
            <div class="flex flex-col gap-4">
                <div class="flex flex-col md:flex-row gap-4">
                    <input type="text" id="noteTitle" placeholder="标题" 
                        class="flex-1 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700">
                    
                    <button id="addNote" class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-lg">
                        <i class="fa fa-plus mr-1"></i> 添加
                    </button>
                </div>
                
                <textarea id="noteContent" placeholder="内容" 
                    class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 min-h-[100px]"></textarea>
                
                <!-- 文件上传区域 -->
                <div>
                    <label class="block text-sm font-medium mb-2">添加文件或图片</label>
                    <div class="flex flex-wrap gap-3">
                        <label class="flex items-center justify-center w-16 h-16 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer">
                            <input type="file" id="fileUpload" class="hidden" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt">
                            <div class="text-center">
                                <i class="fa fa-cloud-upload text-gray-400"></i>
                                <p class="text-xs mt-1 text-gray-500">上传</p>
                            </div>
                        </label>
                        
                        <!-- 文件预览区域 -->
                        <div id="filePreviews" class="flex flex-wrap gap-3"></div>
                    </div>
                    <div id="uploadProgressContainer" class="w-full h-4 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden mt-2 hidden">
                        <div id="uploadProgressBar" class="upload-progress"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 状态和日志区域 -->
        <div class="mb-4">
            <div id="statusMessage" class="py-2 px-4 rounded-lg hidden mb-3"></div>
            
            <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-3 text-sm">
                <p class="font-medium mb-2"><i class="fa fa-list-alt mr-1"></i> 同步日志（点击可复制）</p>
                <div id="logEntries" class="text-xs max-h-40 overflow-y-auto font-mono select-all"></div>
            </div>
        </div>
        
        <!-- 备忘录列表 -->
        <div>
            <h2 class="text-xl font-bold mb-4">我的备忘录</h2>
            <div id="notesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="col-span-full text-center py-12 text-gray-500" id="emptyState">
                    <i class="fa fa-file-text-o text-5xl mb-4 opacity-50"></i>
                    <p>暂无备忘录</p>
                </div>
            </div>
        </div>
    </main>

    <!-- 全屏查看模态框 -->
    <div id="fullscreenViewModal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl p-6 fullscreen-modal modal-enter overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 id="fullscreenTitle" class="text-2xl font-bold"></h3>
                <button id="closeFullscreenBtn" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mb-6">
                <p id="fullscreenContent" class="text-lg leading-relaxed whitespace-pre-line"></p>
            </div>
            
            <!-- 附件显示区域 -->
            <div id="fullscreenFilesContainer" class="mb-6">
                <h4 class="font-medium mb-3 text-lg">附件</h4>
                <div id="fullscreenFiles" class="flex flex-wrap gap-3"></div>
            </div>
            
            <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700 text-sm text-gray-500">
                <p>创建时间: <span id="fullscreenDate"></span></p>
            </div>
            
            <div class="mt-6 flex justify-end gap-3">
                <button id="fullscreenEditBtn" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg">
                    <i class="fa fa-pencil mr-1"></i> 编辑
                </button>
            </div>
        </div>
    </div>

    <!-- 图片查看器模态框 -->
    <div id="imageViewerModal" class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 hidden">
        <div class="max-w-4xl max-h-[90vh] p-4">
            <button id="closeImageViewerBtn" class="absolute top-4 right-4 bg-black/50 text-white p-2 rounded-full hover:bg-black/70">
                <i class="fa fa-times"></i>
            </button>
            <img id="imageViewer" src="" alt="图片预览" class="max-w-full max-h-[85vh] object-contain">
        </div>
    </div>

    <!-- 编辑备忘录模态框 -->
    <div id="editModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl p-6 w-full max-w-2xl mx-4 modal-enter max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">编辑备忘录</h3>
                <button id="closeEditModal" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            
            <input type="hidden" id="editNoteId">
            <div class="flex flex-col gap-4">
                <input type="text" id="editNoteTitle" placeholder="输入标题..." 
                    class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700">
                
                <textarea id="editNoteContent" placeholder="输入内容..." 
                    class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 min-h-[120px]"></textarea>
                
                <!-- 编辑时的文件上传区域 -->
                <div>
                    <label class="block text-sm font-medium mb-2">附件</label>
                    <div class="flex flex-wrap gap-3">
                        <label class="flex items-center justify-center w-16 h-16 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer">
                            <input type="file" id="editFileUpload" class="hidden" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt">
                            <div class="text-center">
                                <i class="fa fa-cloud-upload text-gray-400"></i>
                                <p class="text-xs mt-1 text-gray-500">添加</p>
                            </div>
                        </label>
                        
                        <!-- 编辑时的文件预览区域 -->
                        <div id="editFilePreviews" class="flex flex-wrap gap-3"></div>
                    </div>
                </div>
                
                <div class="flex gap-3 mt-2">
                    <button id="deleteNoteBtn" class="flex-1 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">
                        <i class="fa fa-trash mr-1"></i> 删除
                    </button>
                    <button id="saveEditBtn" class="flex-1 bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg">
                        <i class="fa fa-save mr-1"></i> 保存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 删除确认模态框 -->
    <div id="confirmDeleteModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl p-6 w-full max-w-md mx-4 modal-enter">
            <h3 class="text-xl font-bold mb-3">确认删除</h3>
            <p class="mb-5 text-gray-600 dark:text-gray-300">
                确定要删除这条备忘录吗？此操作将同步到所有设备，且无法撤销。相关文件也将被删除。
            </p>
            
            <input type="hidden" id="deleteNoteId">
            <div class="flex gap-3">
                <button id="cancelDeleteBtn" class="flex-1 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-4 py-2 rounded-lg">
                    取消
                </button>
                <button id="confirmDeleteBtn" class="flex-1 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">
                    <i class="fa fa-trash mr-1"></i> 确认删除
                </button>
            </div>
        </div>
    </div>

    <!-- 删除失败重试模态框 -->
    <div id="deleteFailedModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl p-6 w-full max-w-md mx-4 modal-enter">
            <div class="text-center mb-4">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-100 dark:bg-red-900 text-red-500 dark:text-red-300 mb-4">
                    <i class="fa fa-exclamation-triangle text-3xl"></i>
                </div>
                <h3 class="text-xl font-bold mb-2">删除失败</h3>
                <p class="text-gray-600 dark:text-gray-300 text-sm" id="deleteFailureReason">
                    无法将删除操作同步到云端
                </p>
            </div>
            
            <input type="hidden" id="retryDeleteNoteId">
            <div class="flex gap-3 mt-4">
                <button id="keepLocalBtn" class="flex-1 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-4 py-2 rounded-lg">
                    仅保留本地删除
                </button>
                <button id="retryDeleteBtn" class="flex-1 bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg">
                    <i class="fa fa-refresh mr-1"></i> 重试删除
                </button>
            </div>
        </div>
    </div>

    <script>
        // 配置常量
        const GIST_ID_KEY = 'notes_gist_id';
        const GITHUB_TOKEN_KEY = 'github_token';
        const LAST_SYNC_KEY = 'last_sync_time';
        const MAX_RETRY_ATTEMPTS = 3; // 删除失败最大重试次数
        const MAX_FILE_SIZE = 10 * 1024 * 1024; // 最大文件大小 10MB
        const TEMP_FILES_KEY = 'temp_upload_files'; // 临时存储上传的文件
        
        // DOM元素
        const addNoteBtn = document.getElementById('addNote');
        const noteTitleInput = document.getElementById('noteTitle');
        const noteContentInput = document.getElementById('noteContent');
        const notesContainer = document.getElementById('notesContainer');
        const emptyState = document.getElementById('emptyState');
        const syncBtn = document.getElementById('syncBtn');
        const syncIcon = document.getElementById('syncIcon');
        const syncBadge = document.getElementById('syncBadge');
        const forceSyncBtn = document.getElementById('forceSyncBtn');
        const themeToggleBtn = document.getElementById('themeToggle');
        const githubTokenInput = document.getElementById('githubToken');
        const saveGithubSettingsBtn = document.getElementById('saveGithubSettings');
        const statusMessage = document.getElementById('statusMessage');
        const logEntries = document.getElementById('logEntries');
        const currentGistIdEl = document.getElementById('currentGistId');
        const copyGistIdBtn = document.getElementById('copyGistIdBtn');
        const copyToast = document.getElementById('copyToast');
        const manualGistIdInput = document.getElementById('manualGistId');
        const setManualGistIdBtn = document.getElementById('setManualGistId');
        
        // 文件上传相关元素
        const fileUploadInput = document.getElementById('fileUpload');
        const filePreviewsContainer = document.getElementById('filePreviews');
        const editFileUploadInput = document.getElementById('editFileUpload');
        const editFilePreviewsContainer = document.getElementById('editFilePreviews');
        const uploadProgressContainer = document.getElementById('uploadProgressContainer');
        const uploadProgressBar = document.getElementById('uploadProgressBar');
        
        // 全屏查看相关元素
        const fullscreenViewModal = document.getElementById('fullscreenViewModal');
        const fullscreenTitle = document.getElementById('fullscreenTitle');
        const fullscreenContent = document.getElementById('fullscreenContent');
        const fullscreenDate = document.getElementById('fullscreenDate');
        const fullscreenFilesContainer = document.getElementById('fullscreenFilesContainer');
        const fullscreenFiles = document.getElementById('fullscreenFiles');
        const closeFullscreenBtn = document.getElementById('closeFullscreenBtn');
        const fullscreenEditBtn = document.getElementById('fullscreenEditBtn');
        const fullscreenNoteIdInput = document.createElement('input');
        fullscreenNoteIdInput.type = 'hidden';
        fullscreenNoteIdInput.id = 'fullscreenNoteId';
        document.body.appendChild(fullscreenNoteIdInput);
        
        // 图片查看器相关元素
        const imageViewerModal = document.getElementById('imageViewerModal');
        const imageViewer = document.getElementById('imageViewer');
        const closeImageViewerBtn = document.getElementById('closeImageViewerBtn');
        
        // 编辑和删除相关元素
        const editModal = document.getElementById('editModal');
        const closeEditModalBtn = document.getElementById('closeEditModal');
        const saveEditBtn = document.getElementById('saveEditBtn');
        const deleteNoteBtn = document.getElementById('deleteNoteBtn');
        const editNoteIdInput = document.getElementById('editNoteId');
        const editNoteTitleInput = document.getElementById('editNoteTitle');
        const editNoteContentInput = document.getElementById('editNoteContent');
        const confirmDeleteModal = document.getElementById('confirmDeleteModal');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const deleteNoteIdInput = document.getElementById('deleteNoteId');
        const deleteFailedModal = document.getElementById('deleteFailedModal');
        const keepLocalBtn = document.getElementById('keepLocalBtn');
        const retryDeleteBtn = document.getElementById('retryDeleteBtn');
        const retryDeleteNoteIdInput = document.getElementById('retryDeleteNoteId');
        const deleteFailureReasonEl = document.getElementById('deleteFailureReason');
        
        // 应用状态
        // 笔记结构: { id, title, content, date, isDeleted, files: [{id, name, type, size, content, isImage}] }
        let notes = JSON.parse(localStorage.getItem('notes')) || [];
        let tempFiles = JSON.parse(localStorage.getItem(TEMP_FILES_KEY)) || {}; // 临时存储正在上传的文件
        let isSyncing = false;
        let deleteInProgress = false; // 跟踪删除操作状态
        
        // 初始化
        function init() {
            // 加载主题
            if (localStorage.getItem('theme') === 'dark' || 
                (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
            
            // 加载Token和Gist ID
            const savedToken = localStorage.getItem(GITHUB_TOKEN_KEY);
            if (savedToken) {
                githubTokenInput.value = savedToken;
            }
            updateGistIdDisplay();
            
            // 确保现有笔记结构完整
            notes = notes.map(note => ({
                ...note,
                isDeleted: note.isDeleted || false,
                files: note.files || []
            }));
            saveNotesLocally();
            
            // 渲染笔记
            renderNotes();
            
            // 显示日志区域
            logSync('应用已初始化');
            
            // 绑定文件上传事件
            fileUploadInput.addEventListener('change', handleFileUpload);
            editFileUploadInput.addEventListener('change', handleEditFileUpload);
        }
        
        // 处理文件上传
        function handleFileUpload(e) {
            const files = e.target.files;
            if (!files.length) return;
            
            processFiles(files, filePreviewsContainer);
            
            // 清空input值，允许重复上传同一文件
            fileUploadInput.value = '';
        }
        
        // 处理编辑时的文件上传
        function handleEditFileUpload(e) {
            const files = e.target.files;
            if (!files.length) return;
            
            processFiles(files, editFilePreviewsContainer);
            
            // 清空input值，允许重复上传同一文件
            editFileUploadInput.value = '';
        }
        
        // 处理并预览文件
        function processFiles(files, container) {
            Array.from(files).forEach(file => {
                // 检查文件大小
                if (file.size > MAX_FILE_SIZE) {
                    showStatus(`文件 ${file.name} 过大（超过10MB）`, true);
                    return;
                }
                
                const fileId = `file_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                // 创建文件预览
                const filePreview = document.createElement('div');
                filePreview.className = 'file-preview bg-gray-100 dark:bg-gray-700 rounded-lg p-2 flex flex-col items-center justify-center w-16 h-16 relative';
                filePreview.setAttribute('data-file-id', fileId);
                
                // 读取文件内容
                const reader = new FileReader();
                
                // 检查是否为图片
                const isImage = file.type.startsWith('image/');
                
                if (isImage) {
                    reader.onload = function(e) {
                        filePreview.innerHTML = `
                            <img src="${e.target.result}" alt="${file.name}" class="max-w-full max-h-[60px] object-contain rounded">
                            <p class="text-xs mt-1 text-center truncate w-full">${file.name}</p>
                            <button class="remove-file absolute top-1 right-1 bg-white/80 dark:bg-gray-800/80 rounded-full w-5 h-5 flex items-center justify-center text-red-500 hover:text-red-700">
                                <i class="fa fa-times text-xs"></i>
                            </button>
                        `;
                        
                        // 保存文件到临时存储
                        saveFileToTempStorage(fileId, {
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            content: e.target.result,
                            isImage: true
                        });
                        
                        // 添加删除文件事件
                        filePreview.querySelector('.remove-file').addEventListener('click', (e) => {
                            e.stopPropagation();
                            removeFilePreview(fileId, container);
                        });
                    };
                    reader.readAsDataURL(file);
                } else {
                    // 非图片文件
                    let fileIcon = 'fa-file-o';
                    if (file.type.includes('pdf')) fileIcon = 'fa-file-pdf-o';
                    else if (file.type.includes('word')) fileIcon = 'fa-file-word-o';
                    else if (file.type.includes('excel')) fileIcon = 'fa-file-excel-o';
                    else if (file.type.includes('text')) fileIcon = 'fa-file-text-o';
                    
                    reader.onload = function(e) {
                        filePreview.innerHTML = `
                            <i class="fa ${fileIcon} text-2xl text-gray-500"></i>
                            <p class="text-xs mt-1 text-center truncate w-full">${file.name}</p>
                            <button class="remove-file absolute top-1 right-1 bg-white/80 dark:bg-gray-800/80 rounded-full w-5 h-5 flex items-center justify-center text-red-500 hover:text-red-700">
                                <i class="fa fa-times text-xs"></i>
                            </button>
                        `;
                        
                        // 对于大文件，我们只存储文件名和类型，在上传时再读取内容
                        // 这里为了简单，小文件直接存储base64
                        if (file.size < 1 * 1024 * 1024) { // 小于1MB的文件
                            saveFileToTempStorage(fileId, {
                                name: file.name,
                                type: file.type,
                                size: file.size,
                                content: e.target.result,
                                isImage: false
                            });
                        } else {
                            saveFileToTempStorage(fileId, {
                                name: file.name,
                                type: file.type,
                                size: file.size,
                                content: null, // 大文件内容稍后处理
                                isImage: false,
                                needsProcessing: true,
                                lastModified: file.lastModified
                            });
                        }
                        
                        // 添加删除文件事件
                        filePreview.querySelector('.remove-file').addEventListener('click', (e) => {
                            e.stopPropagation();
                            removeFilePreview(fileId, container);
                        });
                    };
                    
                    if (file.size < 1 * 1024 * 1024) {
                        reader.readAsDataURL(file);
                    } else {
                        // 大文件先不读取内容
                        reader.onload = reader.onload; // 已经定义
                        reader.readAsArrayBuffer(file); // 只是触发onload
                    }
                }
                
                container.appendChild(filePreview);
            });
        }
        
        // 保存文件到临时存储
        function saveFileToTempStorage(fileId, fileData) {
            tempFiles[fileId] = fileData;
            localStorage.setItem(TEMP_FILES_KEY, JSON.stringify(tempFiles));
        }
        
        // 从临时存储中移除文件
        function removeFileFromTempStorage(fileId) {
            if (tempFiles[fileId]) {
                delete tempFiles[fileId];
                localStorage.setItem(TEMP_FILES_KEY, JSON.stringify(tempFiles));
            }
        }
        
        // 移除文件预览
        function removeFilePreview(fileId, container) {
            const preview = container.querySelector(`[data-file-id="${fileId}"]`);
            if (preview) {
                container.removeChild(preview);
                removeFileFromTempStorage(fileId);
            }
        }
        
        // 获取临时文件列表
        function getTempFiles(container) {
            const fileIds = Array.from(container.querySelectorAll('[data-file-id]')).map(el => el.getAttribute('data-file-id'));
            return fileIds.map(id => ({...tempFiles[id], id})).filter(Boolean);
        }
        
        // 渲染笔记 - 过滤已删除的笔记
        function renderNotes() {
            notesContainer.innerHTML = '';
            
            // 只显示未删除的笔记
            const activeNotes = notes.filter(note => !note.isDeleted);
            
            if (activeNotes.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            activeNotes.forEach(note => {
                const noteElement = document.createElement('div');
                noteElement.className = 'bg-white dark:bg-gray-800 rounded-xl p-4 shadow hover:shadow-lg transition-all duration-300 hover:-translate-y-1 cursor-pointer note-card';
                noteElement.setAttribute('data-id', note.id);
                
                // 生成文件缩略图预览
                let filesPreview = '';
                if (note.files && note.files.length > 0) {
                    const fileIcons = note.files.map(file => {
                        if (file.isImage) {
                            return `<img src="${file.content}" alt="${file.name}" class="w-6 h-6 rounded object-cover mr-1">`;
                        } else {
                            let icon = 'fa-file-o';
                            if (file.type.includes('pdf')) icon = 'fa-file-pdf-o';
                            else if (file.type.includes('word')) icon = 'fa-file-word-o';
                            else if (file.type.includes('excel')) icon = 'fa-file-excel-o';
                            else if (file.type.includes('text')) icon = 'fa-file-text-o';
                            return `<i class="fa ${icon} text-gray-500 mr-1"></i>`;
                        }
                    }).join('');
                    
                    filesPreview = `
                        <div class="mt-2 flex items-center">
                            <span class="text-xs text-gray-500 mr-1">附件: ${note.files.length}个</span>
                            <div class="flex">${fileIcons}</div>
                        </div>
                    `;
                }
                
                noteElement.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold">${note.title}</h3>
                        <button class="edit-btn p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700" data-id="${note.id}">
                            <i class="fa fa-pencil text-gray-500"></i>
                        </button>
                    </div>
                    <p class="text-gray-600 dark:text-gray-300 mb-2 line-clamp-2">${note.content}</p>
                    <div class="text-xs text-gray-400">
                        ${new Date(note.date).toLocaleString()}
                    </div>
                    ${filesPreview}
                `;
                notesContainer.appendChild(noteElement);
            });
            
            // 为笔记卡片添加点击事件（全屏查看）
            document.querySelectorAll('.note-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    // 如果点击的是编辑按钮，则不触发全屏查看
                    if (!e.target.closest('.edit-btn')) {
                        const noteId = card.getAttribute('data-id');
                        openFullscreenView(noteId);
                    }
                });
            });
            
            // 编辑按钮事件
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation(); // 阻止事件冒泡到卡片
                    openEditModal(e);
                });
            });
        }
        
        // 打开全屏查看模态框
        function openFullscreenView(noteId) {
            const note = notes.find(n => n.id === noteId && !n.isDeleted);
            
            if (note) {
                fullscreenNoteIdInput.value = note.id;
                fullscreenTitle.textContent = note.title;
                fullscreenContent.textContent = note.content;
                fullscreenDate.textContent = new Date(note.date).toLocaleString();
                
                // 显示文件
                if (note.files && note.files.length > 0) {
                    fullscreenFilesContainer.classList.remove('hidden');
                    fullscreenFiles.innerHTML = '';
                    
                    note.files.forEach(file => {
                        const fileElement = document.createElement('div');
                        fileElement.className = 'file-preview bg-gray-100 dark:bg-gray-700 rounded-lg p-3 flex items-center gap-2 max-w-xs cursor-pointer';
                        
                        if (file.isImage) {
                            fileElement.innerHTML = `
                                <img src="${file.content}" alt="${file.name}" class="w-10 h-10 rounded object-cover">
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium truncate">${file.name}</p>
                                    <p class="text-xs text-gray-500">${formatFileSize(file.size)}</p>
                                </div>
                            `;
                            
                            // 点击图片查看大图
                            fileElement.addEventListener('click', () => {
                                imageViewer.src = file.content;
                                imageViewer.alt = file.name;
                                imageViewerModal.classList.remove('hidden');
                            });
                        } else {
                            let fileIcon = 'fa-file-o';
                            if (file.type.includes('pdf')) fileIcon = 'fa-file-pdf-o';
                            else if (file.type.includes('word')) fileIcon = 'fa-file-word-o';
                            else if (file.type.includes('excel')) fileIcon = 'fa-file-excel-o';
                            else if (file.type.includes('text')) fileIcon = 'fa-file-text-o';
                            
                            fileElement.innerHTML = `
                                <i class="fa ${fileIcon} text-2xl text-gray-500"></i>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium truncate">${file.name}</p>
                                    <p class="text-xs text-gray-500">${formatFileSize(file.size)}</p>
                                </div>
                                <button class="download-file p-2 text-primary hover:text-primary/80">
                                    <i class="fa fa-download"></i>
                                </button>
                            `;
                            
                            // 点击下载文件
                            fileElement.querySelector('.download-file').addEventListener('click', (e) => {
                                e.stopPropagation();
                                downloadFile(file);
                            });
                        }
                        
                        fullscreenFiles.appendChild(fileElement);
                    });
                } else {
                    fullscreenFilesContainer.classList.add('hidden');
                }
                
                fullscreenViewModal.classList.remove('hidden');
            }
        }
        
        // 下载文件
        function downloadFile(file) {
            try {
                if (!file.content) {
                    showStatus('文件内容不可用', true);
                    return;
                }
                
                // 解析base64内容
                const base64Data = file.content.split(',')[1];
                const byteCharacters = atob(base64Data);
                const byteNumbers = new Array(byteCharacters.length);
                
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: file.type });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = file.name;
                document.body.appendChild(a);
                a.click();
                
                // 清理
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
                
                logSync(`已下载文件: ${file.name}`);
            } catch (error) {
                console.error('文件下载失败:', error);
                showStatus(`文件下载失败: ${error.message}`, true);
            }
        }
        
        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // 关闭全屏查看模态框
        function closeFullscreenView() {
            const modalContent = fullscreenViewModal.querySelector('.modal-enter');
            modalContent.classList.remove('modal-enter');
            modalContent.classList.add('modal-exit');
            
            setTimeout(() => {
                fullscreenViewModal.classList.add('hidden');
                modalContent.classList.remove('modal-exit');
                modalContent.classList.add('modal-enter');
            }, 300);
        }
        
        // 关闭图片查看器
        function closeImageViewer() {
            imageViewerModal.classList.add('hidden');
            imageViewer.src = '';
        }
        
        // 从全屏查看切换到编辑
        function switchToEditFromFullscreen() {
            const noteId = fullscreenNoteIdInput.value;
            closeFullscreenView();
            
            // 短暂延迟后显示编辑框
            setTimeout(() => {
                const note = notes.find(n => n.id === noteId && !n.isDeleted);
                if (note) {
                    openEditModalWithNote(note);
                }
            }, 350);
        }
        
        // 打开编辑模态框并填充数据
        function openEditModalWithNote(note) {
            editNoteIdInput.value = note.id;
            editNoteTitleInput.value = note.title;
            editNoteContentInput.value = note.content;
            
            // 清空并添加现有文件
            editFilePreviewsContainer.innerHTML = '';
            if (note.files && note.files.length > 0) {
                note.files.forEach(file => {
                    const filePreview = document.createElement('div');
                    filePreview.className = 'file-preview bg-gray-100 dark:bg-gray-700 rounded-lg p-2 flex flex-col items-center justify-center w-16 h-16 relative';
                    filePreview.setAttribute('data-file-id', file.id);
                    
                    // 保存到临时存储，以便编辑时可以删除
                    saveFileToTempStorage(file.id, file);
                    
                    if (file.isImage) {
                        filePreview.innerHTML = `
                            <img src="${file.content}" alt="${file.name}" class="max-w-full max-h-[60px] object-contain rounded">
                            <p class="text-xs mt-1 text-center truncate w-full">${file.name}</p>
                            <button class="remove-file absolute top-1 right-1 bg-white/80 dark:bg-gray-800/80 rounded-full w-5 h-5 flex items-center justify-center text-red-500 hover:text-red-700">
                                <i class="fa fa-times text-xs"></i>
                            </button>
                        `;
                    } else {
                        let fileIcon = 'fa-file-o';
                        if (file.type.includes('pdf')) fileIcon = 'fa-file-pdf-o';
                        else if (file.type.includes('word')) fileIcon = 'fa-file-word-o';
                        else if (file.type.includes('excel')) fileIcon = 'fa-file-excel-o';
                        else if (file.type.includes('text')) fileIcon = 'fa-file-text-o';
                        
                        filePreview.innerHTML = `
                            <i class="fa ${fileIcon} text-2xl text-gray-500"></i>
                            <p class="text-xs mt-1 text-center truncate w-full">${file.name}</p>
                            <button class="remove-file absolute top-1 right-1 bg-white/80 dark:bg-gray-800/80 rounded-full w-5 h-5 flex items-center justify-center text-red-500 hover:text-red-700">
                                <i class="fa fa-times text-xs"></i>
                            </button>
                        `;
                    }
                    
                    // 添加删除文件事件
                    filePreview.querySelector('.remove-file').addEventListener('click', (e) => {
                        e.stopPropagation();
                        removeFilePreview(file.id, editFilePreviewsContainer);
                    });
                    
                    editFilePreviewsContainer.appendChild(filePreview);
                });
            }
            
            editModal.classList.remove('hidden');
            editNoteTitleInput.focus();
        }
        
        // 打开编辑模态框
        function openEditModal(e) {
            const id = e.currentTarget.getAttribute('data-id');
            const note = notes.find(n => n.id === id && !n.isDeleted);
            
            if (note) {
                openEditModalWithNote(note);
            }
        }
        
        // 关闭编辑模态框
        function closeEditModal() {
            const modalContent = editModal.querySelector('.modal-enter');
            modalContent.classList.remove('modal-enter');
            modalContent.classList.add('modal-exit');
            
            setTimeout(() => {
                editModal.classList.add('hidden');
                modalContent.classList.remove('modal-exit');
                modalContent.classList.add('modal-enter');
                // 清空编辑时的文件预览
                editFilePreviewsContainer.innerHTML = '';
                // 清除相关的临时文件
                Array.from(editFilePreviewsContainer.querySelectorAll('[data-file-id]')).forEach(el => {
                    removeFileFromTempStorage(el.getAttribute('data-file-id'));
                });
            }, 300);
        }
        
        // 添加笔记
        function addNote() {
            const title = noteTitleInput.value.trim();
            const content = noteContentInput.value.trim();
            
            if (!title && !content && filePreviewsContainer.children.length === 0) {
                showStatus('请输入内容或添加文件', true);
                return;
            }
            
            // 获取上传的文件
            const files = getTempFiles(filePreviewsContainer);
            
            const newNote = {
                id: Date.now().toString(),
                title,
                content,
                date: new Date().toISOString(),
                isDeleted: false,
                files: files
            };
            
            notes.unshift(newNote);
            saveNotesLocally();
            renderNotes();
            logSync(`已添加笔记: ${title || '无标题'}，包含 ${files.length} 个文件`);
            
            // 清空输入
            noteTitleInput.value = '';
            noteContentInput.value = '';
            filePreviewsContainer.innerHTML = '';
            
            // 清除临时文件
            files.forEach(file => removeFileFromTempStorage(file.id));
            
            // 自动同步
            if (localStorage.getItem(GITHUB_TOKEN_KEY)) {
                syncNotes();
            }
        }
        
        // 保存编辑
        function saveEdit() {
            const id = editNoteIdInput.value;
            const title = editNoteTitleInput.value.trim();
            const content = editNoteContentInput.value.trim();
            
            // 获取编辑时的文件
            const files = getTempFiles(editFilePreviewsContainer);
            
            if (!title && !content && files.length === 0) {
                closeEditModal();
                return;
            }
            
            const index = notes.findIndex(n => n.id === id);
            if (index !== -1) {
                const oldTitle = notes[index].title;
                notes[index] = {
                    ...notes[index],
                    title,
                    content,
                    files: files,
                    date: new Date().toISOString() // 更新修改时间
                };
                
                saveNotesLocally();
                renderNotes();
                logSync(`已更新笔记: ${oldTitle || '无标题'}，包含 ${files.length} 个文件`);
                closeEditModal();
                
                // 立即同步更新
                if (localStorage.getItem(GITHUB_TOKEN_KEY)) {
                    syncNotes();
                }
            }
        }
        
        // 打开删除确认模态框
        function openDeleteConfirmModal() {
            const noteId = editNoteIdInput.value;
            deleteNoteIdInput.value = noteId;
            closeEditModal();
            
            // 短暂延迟后显示删除确认框
            setTimeout(() => {
                confirmDeleteModal.classList.remove('hidden');
            }, 350);
        }
        
        // 关闭删除确认模态框
        function closeDeleteConfirmModal() {
            const modalContent = confirmDeleteModal.querySelector('.modal-enter');
            modalContent.classList.remove('modal-enter');
            modalContent.classList.add('modal-exit');
            
            setTimeout(() => {
                confirmDeleteModal.classList.add('hidden');
                modalContent.classList.remove('modal-exit');
                modalContent.classList.add('modal-enter');
            }, 300);
        }
        
        // 关闭删除失败模态框
        function closeDeleteFailedModal() {
            const modalContent = deleteFailedModal.querySelector('.modal-enter');
            modalContent.classList.remove('modal-enter');
            modalContent.classList.add('modal-exit');
            
            setTimeout(() => {
                deleteFailedModal.classList.add('hidden');
                modalContent.classList.remove('modal-exit');
                modalContent.classList.add('modal-enter');
            }, 300);
        }
        
        // 确认删除笔记 - 标记为已删除而非直接移除
        function confirmDelete() {
            const id = deleteNoteIdInput.value;
            const note = notes.find(n => n.id === id && !n.isDeleted);
            
            if (note && !deleteInProgress) {
                closeDeleteConfirmModal();
                // 执行删除操作，最多重试MAX_RETRY_ATTEMPTS次
                executeDeleteWithRetry(id, note, 0);
            }
        }
        
        // 带重试机制的删除操作 - 使用删除标记
        async function executeDeleteWithRetry(noteId, note, attempt) {
            if (deleteInProgress || attempt > MAX_RETRY_ATTEMPTS) return;
            
            deleteInProgress = true;
            let isFirstAttempt = attempt === 0;
            
            try {
                // 第一次尝试时先在本地标记为已删除
                if (isFirstAttempt) {
                    const index = notes.findIndex(n => n.id === noteId);
                    if (index !== -1) {
                        notes[index] = {
                            ...notes[index],
                            isDeleted: true,
                            date: new Date().toISOString() // 更新删除时间作为同步依据
                        };
                        saveNotesLocally();
                        renderNotes();
                        logSync(`[尝试 ${attempt + 1}] 已在本地标记笔记为删除: ${note.title || '无标题'}`);
                        showStatus(`正在同步删除操作 (尝试 ${attempt + 1}/${MAX_RETRY_ATTEMPTS})...`);
                    } else {
                        throw new Error('未找到要删除的笔记');
                    }
                }
                
                // 同步删除标记到云端
                const token = localStorage.getItem(GITHUB_TOKEN_KEY);
                const gistId = localStorage.getItem(GIST_ID_KEY);
                
                if (!token || !gistId) {
                    throw new Error('缺少GitHub令牌或Gist ID，无法同步删除操作');
                }
                
                // 1. 先获取最新的云端数据
                logSync(`[尝试 ${attempt + 1}] 获取最新云端数据...`);
                const getResponse = await fetch(`https://api.github.com/gists/${gistId}`, {
                    headers: { Authorization: `token ${token}` }
                });
                
                if (!getResponse.ok) {
                    throw new Error(`获取云端数据失败，状态码: ${getResponse.status}`);
                }
                
                const gistData = await getResponse.json();
                let cloudNotes = gistData.files && gistData.files['notes.json'] 
                    ? JSON.parse(gistData.files['notes.json'].content || '[]')
                    : [];
                
                // 确保云端笔记有必要的属性
                cloudNotes = cloudNotes.map(n => ({
                    ...n, 
                    isDeleted: n.isDeleted || false,
                    files: n.files || []
                }));
                
                // 2. 在云端数据中标记该笔记为已删除
                logSync(`[尝试 ${attempt + 1}] 在云端数据中标记笔记为删除...`);
                const noteIndex = cloudNotes.findIndex(n => n.id === noteId);
                if (noteIndex !== -1) {
                    cloudNotes[noteIndex] = {
                        ...cloudNotes[noteIndex],
                        isDeleted: true,
                        date: new Date().toISOString()
                    };
                } else {
                    // 如果云端没有这条笔记，仍然记录删除操作
                    logSync(`[尝试 ${attempt + 1}] 云端未找到该笔记，视为已删除`);
                }
                
                // 3. 强制上传更新后的笔记列表（确保删除标记被同步）
                logSync(`[尝试 ${attempt + 1}] 上传包含删除标记的笔记列表到云端...`);
                const updateResponse = await fetch(`https://api.github.com/gists/${gistId}`, {
                    method: 'PATCH',
                    headers: {
                        Authorization: `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: { 'notes.json': { content: JSON.stringify(cloudNotes) } }
                    })
                });
                
                if (!updateResponse.ok) {
                    const error = await updateResponse.json();
                    throw new Error(`上传删除结果失败: ${error.message || '未知错误'}`);
                }
                
                // 4. 删除标记同步成功
                logSync(`[尝试 ${attempt + 1}] 笔记删除标记已成功同步到云端: ${note.title || '无标题'}`);
                showStatus('笔记已成功删除并同步到所有设备');
                deleteInProgress = false;
                
            } catch (error) {
                console.error(`删除尝试 ${attempt + 1} 失败:`, error);
                logSync(`[尝试 ${attempt + 1}] 删除同步失败: ${error.message}`);
                
                // 如果还有重试次数，继续重试
                if (attempt < MAX_RETRY_ATTEMPTS - 1) {
                    showStatus(`删除同步失败，将重试 (${attempt + 1}/${MAX_RETRY_ATTEMPTS})...`, true);
                    
                    // 延迟重试，避免频繁请求
                    setTimeout(() => {
                        deleteInProgress = false;
                        executeDeleteWithRetry(noteId, note, attempt + 1);
                    }, 2000 * (attempt + 1)); // 指数退避策略
                } else {
                    // 所有重试都失败，显示失败模态框
                    deleteFailureReasonEl.textContent = error.message;
                    retryDeleteNoteIdInput.value = noteId;
                    
                    setTimeout(() => {
                        deleteFailedModal.classList.remove('hidden');
                        showStatus('删除标记同步失败', true);
                        deleteInProgress = false;
                    }, 500);
                }
            }
        }
        
        // 重试删除操作
        function retryDelete() {
            const noteId = retryDeleteNoteIdInput.value;
            const note = notes.find(n => n.id === noteId) || { id: noteId, title: '待删除笔记' };
            
            closeDeleteFailedModal();
            showStatus('正在重试删除同步...');
            executeDeleteWithRetry(noteId, note, 0);
        }
        
        // 仅保留本地删除
        function keepLocalDelete() {
            const noteId = retryDeleteNoteIdInput.value;
            logSync('用户选择仅保留本地删除标记，不同步到云端');
            showStatus('笔记已在本地删除，但其他设备可能仍会显示');
            closeDeleteFailedModal();
        }
        
        // 本地保存
        function saveNotesLocally() {
            localStorage.setItem('notes', JSON.stringify(notes));
        }
        
        // 显示状态消息
        function showStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden', 'bg-green-100', 'text-green-800', 
                                      'bg-yellow-100', 'text-yellow-800',
                                      'bg-red-100', 'text-red-800', 'delete-error',
                                      'dark:bg-green-900', 'dark:text-green-100',
                                      'dark:bg-yellow-900', 'dark:text-yellow-100',
                                      'dark:bg-red-900', 'dark:text-red-100');
            
            if (isError) {
                statusMessage.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-900', 'dark:text-red-100');
                // 如果是删除错误，添加抖动动画
                if (message.includes('删除失败')) {
                    statusMessage.classList.add('delete-error');
                }
            } else if (message.includes('正在') || message.includes('尝试')) {
                statusMessage.classList.add('bg-yellow-100', 'text-yellow-800', 'dark:bg-yellow-900', 'dark:text-yellow-100');
            } else {
                statusMessage.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-900', 'dark:text-green-100');
            }
        }
        
        // 记录同步日志
        function logSync(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'mb-1 pb-1 border-b border-gray-200 dark:border-gray-700 last:border-0 last:mb-0 last:pb-0';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logEntries.prepend(logEntry);
            
            // 限制日志数量
            if (logEntries.children.length > 50) {
                logEntries.removeChild(logEntries.lastChild);
            }
        }
        
        // 更新Gist ID显示
        function updateGistIdDisplay() {
            const gistId = localStorage.getItem(GIST_ID_KEY);
            currentGistIdEl.textContent = gistId ? `${gistId.substring(0, 8)}...` : '未连接';
            currentGistIdEl.title = gistId || '未连接到任何Gist';
            
            // 没有Gist ID时禁用复制按钮
            copyGistIdBtn.disabled = !gistId;
            copyGistIdBtn.classList.toggle('opacity-50', !gistId);
            copyGistIdBtn.classList.toggle('cursor-not-allowed', !gistId);
        }
        
        // 复制Gist ID到剪贴板
        function copyGistId() {
            const gistId = localStorage.getItem(GIST_ID_KEY);
            if (gistId) {
                navigator.clipboard.writeText(gistId).then(() => {
                    // 显示复制成功提示
                    copyToast.classList.remove('hidden');
                    setTimeout(() => {
                        copyToast.classList.add('hidden');
                    }, 3000);
                    logSync('Gist ID已复制到剪贴板');
                }).catch(err => {
                    console.error('复制失败:', err);
                    showStatus('复制失败，请手动记录', true);
                });
            }
        }
        
        // 同步逻辑 - 处理文件和删除标记
        async function syncNotes(force = false) {
            return new Promise(async (resolve, reject) => {
                if (isSyncing || deleteInProgress) {
                    resolve();
                    return;
                }
                
                const token = localStorage.getItem(GITHUB_TOKEN_KEY);
                if (!token) {
                    showStatus('请先设置GitHub令牌', true);
                    resolve();
                    return;
                }
                
                try {
                    isSyncing = true;
                    syncIcon.classList.add('sync-pulse');
                    syncBtn.disabled = true;
                    forceSyncBtn.disabled = true;
                    showStatus(force ? '正在强制同步...' : '正在同步...');
                    logSync(`=== ${force ? '强制同步' : '常规同步'}开始 ===`);
                    
                    // 获取或创建Gist
                    let gistId = localStorage.getItem(GIST_ID_KEY);
                    logSync(`当前Gist ID: ${gistId || '无'}`);
                    
                    // 如果没有Gist ID，创建新的
                    if (!gistId) {
                        logSync('没有找到Gist ID，尝试创建新Gist...');
                        const createResponse = await fetch('https://api.github.com/gists', {
                            method: 'POST',
                            headers: {
                                Authorization: `token ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                description: '备忘录同步数据',
                                public: false,
                                files: { 'notes.json': { content: JSON.stringify(notes) } }
                            })
                        });
                        
                        if (!createResponse.ok) {
                            const error = await createResponse.json();
                            throw new Error(`创建Gist失败: ${error.message || '未知错误'}`);
                        }
                        
                        const newGist = await createResponse.json();
                        gistId = newGist.id;
                        localStorage.setItem(GIST_ID_KEY, gistId);
                        logSync(`已创建新Gist，ID: ${gistId}`);
                        updateGistIdDisplay();
                    }
                    
                    // 从云端获取数据
                    logSync(`尝试从Gist获取数据: ${gistId.substring(0, 8)}...`);
                    const getResponse = await fetch(`https://api.github.com/gists/${gistId}`, {
                        headers: { Authorization: `token ${token}` }
                    });
                    
                    if (!getResponse.ok) {
                        throw new Error(`获取云端数据失败，状态码: ${getResponse.status}`);
                    }
                    
                    const gistData = await getResponse.json();
                    let cloudNotes = gistData.files && gistData.files['notes.json'] 
                        ? JSON.parse(gistData.files['notes.json'].content || '[]')
                        : [];
                    
                    // 确保云端笔记结构完整
                    cloudNotes = cloudNotes.map(n => ({
                        ...n, 
                        isDeleted: n.isDeleted || false,
                        files: n.files || []
                    }));
                    
                    logSync(`从云端获取到 ${cloudNotes.length} 条笔记（包含删除标记和文件）`);
                    
                    // 处理删除标记同步
                    // 1. 找出所有被标记为删除的笔记ID
                    const deletedNoteIds = new Set();
                    notes.forEach(note => {
                        if (note.isDeleted) deletedNoteIds.add(note.id);
                    });
                    cloudNotes.forEach(note => {
                        if (note.isDeleted) deletedNoteIds.add(note.id);
                    });
                    
                    logSync(`检测到 ${deletedNoteIds.size} 个删除标记`);
                    
                    // 2. 合并笔记数据，优先保留最新状态
                    const mergedNotes = [];
                    const allNoteIds = new Set([
                        ...notes.map(n => n.id),
                        ...cloudNotes.map(n => n.id)
                    ]);
                    
                    allNoteIds.forEach(noteId => {
                        const localNote = notes.find(n => n.id === noteId);
                        const cloudNote = cloudNotes.find(n => n.id === noteId);
                        
                        // 处理删除标记：只要任何一方标记为删除，就视为删除
                        const isDeleted = (localNote?.isDeleted || false) || (cloudNote?.isDeleted || false);
                        
                        if (!localNote && !cloudNote) return;
                        
                        // 确定使用哪个版本（本地或云端）
                        let selectedNote;
                        if (!localNote) {
                            selectedNote = cloudNote;
                        } else if (!cloudNote) {
                            selectedNote = localNote;
                        } else {
                            // 选择更新的版本
                            selectedNote = new Date(localNote.date) > new Date(cloudNote.date) 
                                ? localNote 
                                : cloudNote;
                        }
                        
                        // 应用删除标记
                        mergedNotes.push({
                            ...selectedNote,
                            isDeleted
                        });
                        
                        if (isDeleted) {
                            logSync(`合并: 笔记 ${noteId.substring(0, 6)}... 被标记为删除`);
                        } else if (selectedNote.files && selectedNote.files.length > 0) {
                            logSync(`合并: 笔记 ${noteId.substring(0, 6)}... 包含 ${selectedNote.files.length} 个文件`);
                        }
                    });
                    
                    // 3. 保存合并结果并按日期排序
                    notes = mergedNotes.sort((a, b) => new Date(b.date) - new Date(a.date));
                    saveNotesLocally();
                    renderNotes();
                    
                    // 4. 上传合并后的结果到云端
                    logSync(`上传 ${notes.length} 条笔记（包含文件数据）到云端`);
                    
                    // 显示上传进度
                    uploadProgressContainer.classList.remove('hidden');
                    uploadProgressBar.style.width = '30%';
                    
                    const updateResponse = await fetch(`https://api.github.com/gists/${gistId}`, {
                        method: 'PATCH',
                        headers: {
                            Authorization: `token ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            files: { 'notes.json': { content: JSON.stringify(notes) } }
                        })
                    });
                    
                    uploadProgressBar.style.width = '100%';
                    
                    if (!updateResponse.ok) {
                        const error = await updateResponse.json();
                        throw new Error(`上传到云端失败: ${error.message || '未知错误'}`);
                    }
                    
                    // 5. 清理已确认删除的笔记（可选：保留一段时间以便恢复）
                    cleanupDeletedNotes();
                    
                    showStatus(`同步完成，共 ${notes.filter(n => !n.isDeleted).length} 条有效笔记`);
                    
                    // 隐藏进度条
                    setTimeout(() => {
                        uploadProgressContainer.classList.add('hidden');
                        uploadProgressBar.style.width = '0%';
                    }, 500);
                    
                    // 更新最后同步时间
                    localStorage.setItem(LAST_SYNC_KEY, new Date().toISOString());
                    logSync('同步完成');
                    resolve();
                    
                } catch (error) {
                    console.error('同步错误:', error);
                    showStatus(`同步失败: ${error.message}`, true);
                    logSync(`错误: ${error.message}`);
                    
                    // 重置进度条
                    uploadProgressContainer.classList.add('hidden');
                    uploadProgressBar.style.width = '0%';
                    
                    reject(error);
                } finally {
                    isSyncing = false;
                    syncIcon.classList.remove('sync-pulse');
                    syncBtn.disabled = false;
                    forceSyncBtn.disabled = false;
                    syncBadge.classList.remove('hidden');
                    setTimeout(() => syncBadge.classList.add('hidden'), 3000);
                }
            });
        }
        
        // 清理已确认删除的笔记（超过7天的彻底删除）
        function cleanupDeletedNotes() {
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            
            const notesToRemove = notes.filter(note => 
                note.isDeleted && new Date(note.date) < sevenDaysAgo
            );
            
            if (notesToRemove.length > 0) {
                logSync(`清理 ${notesToRemove.length} 条已删除超过7天的笔记`);
                notes = notes.filter(note => 
                    !note.isDeleted || new Date(note.date) >= sevenDaysAgo
                );
                saveNotesLocally();
            }
        }
        
        // 手动设置Gist ID
        function setManualGistId() {
            const gistId = manualGistIdInput.value.trim();
            if (gistId) {
                localStorage.setItem(GIST_ID_KEY, gistId);
                updateGistIdDisplay();
                logSync(`已手动设置Gist ID: ${gistId.substring(0, 8)}...`);
                showStatus('Gist ID已更新，建议立即同步');
                manualGistIdInput.value = '';
            }
        }
        
        // 事件监听
        addNoteBtn.addEventListener('click', addNote);
        syncBtn.addEventListener('click', () => syncNotes(false));
        forceSyncBtn.addEventListener('click', () => syncNotes(true));
        themeToggleBtn.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        });
        saveGithubSettingsBtn.addEventListener('click', () => {
            const token = githubTokenInput.value.trim();
            if (token) {
                localStorage.setItem(GITHUB_TOKEN_KEY, token);
                showStatus('GitHub令牌已保存，正在同步...');
                syncNotes();
            } else {
                localStorage.removeItem(GITHUB_TOKEN_KEY);
                showStatus('已清除GitHub令牌', true);
            }
        });
        setManualGistIdBtn.addEventListener('click', setManualGistId);
        copyGistIdBtn.addEventListener('click', copyGistId);
        
        // 全屏查看相关事件
        closeFullscreenBtn.addEventListener('click', closeFullscreenView);
        fullscreenEditBtn.addEventListener('click', switchToEditFromFullscreen);
        
        // 图片查看器相关事件
        closeImageViewerBtn.addEventListener('click', closeImageViewer);
        imageViewerModal.addEventListener('click', (e) => {
            if (e.target === imageViewerModal) closeImageViewer();
        });
        
        // 点击全屏模态框外部关闭
        fullscreenViewModal.addEventListener('click', (e) => {
            if (e.target === fullscreenViewModal) closeFullscreenView();
        });
        
        // 编辑相关事件
        closeEditModalBtn.addEventListener('click', closeEditModal);
        saveEditBtn.addEventListener('click', saveEdit);
        deleteNoteBtn.addEventListener('click', openDeleteConfirmModal);
        
        // 删除确认相关事件
        cancelDeleteBtn.addEventListener('click', closeDeleteConfirmModal);
        confirmDeleteBtn.addEventListener('click', confirmDelete);
        
        // 删除失败相关事件
        keepLocalBtn.addEventListener('click', keepLocalDelete);
        retryDeleteBtn.addEventListener('click', retryDelete);
        
        // 删除确认模态框外部关闭
        confirmDeleteModal.addEventListener('click', (e) => {
            if (e.target === confirmDeleteModal) closeDeleteConfirmModal();
        });
        deleteFailedModal.addEventListener('click', (e) => {
            if (e.target === deleteFailedModal) closeDeleteFailedModal();
        });
        
        // 按ESC键关闭所有模态框
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeFullscreenView();
                closeImageViewer();
                closeEditModal();
                closeDeleteConfirmModal();
                closeDeleteFailedModal();
            }
        });
        
        // 初始化
        init();
    </script>
</body>
</html>
